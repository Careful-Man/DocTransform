(*
  еПЕИДч АККэФЕИ ЙэХЕ ЖОЯэ ТО format ТОУ excel, ПЯщПЕИ МА ПЯОБКщЬЫ
  ТГМ ЩПАЯНГ ч ЭВИ ДИАЖОЯЕТИЙЭ format ГЛАЯОЛГМъАР ЙАИ АЯИХЛЧМ.

  пЯщПЕИ МА АЖАИЯЧ ТГМ ГЛщЯА ТГР ЕБДОЛэДАР АПЭ ТГМ ГЛ/МъА.
*)
unit o_Georgiadis;

interface

uses
   Windows
  ,SysUtils
  ,Classes
  ,Controls
  ,Forms
  ,Dialogs
  ,Contnrs
  ,Db
  ,Variants
  ,StrUtils
//  ,tpk_Utls
  ,o_Descriptors
  ,o_Managers
  ,o_Purchases
  ,uStringHandlingRoutines
  ;

type
(*----------------------------------------------------------------------------
O ПЕЯИЦЯАЖщАР ХА ПЯщПЕИ МА щВЕИ ЙАТАСТэСЕИР
  NoLine
  HeaderLine
  DetailLine
  SkipLine
ЙАИ О АМАЦМЧСТГР МА ТОУ ПЕЯМэЕИ ЙэХЕ ЦЯАЛЛч ЙАИ МА ТОМ СУЛБОУКЕЩЕТАИ

*)
  TGeorgiadisDescriptor = class(TFileDescriptor)
  protected
    procedure AddFileItems(); override;
  public
    constructor Create(); override;
  end;
(*----------------------------------------------------------------------------*)
 TGeorgiadisReader = class(TPurchaseReader)
 protected
   //function  ResolveGLN: Boolean; override;
   //function  GetDocDate: TDate; override;
   function GetGLN(): string; override;
//   function GetRelDocNum: string; override;
   function GetMaterialCode(SupMatCode: string; SupCode: string; out MatCode: string; out MatAA: Integer): Boolean; override;
   function GetDiscount: double; override;
   function GetLineValue: Double; override;
   function GetVAT(MatCode: string): string; override;
   function DocStrToDate(S: string): TDate; override;
 public
   constructor Create(Manager: TInputManager; Title: string); override;
 end;


implementation


{ TFarmaKoukakiDescriptor }
(*----------------------------------------------------------------------------*)
constructor TGeorgiadisDescriptor.Create;
begin
  inherited;

  FName            := 'Input.Descriptor.цеыяциадгс';
  FFileName        := 'цеыяциадгс\ажяодитг_тилокоциа*.csv';
  FKind            := fkDelimited;
  FDelimiter       := ';';
  FSchema          := fsSameLine;
  FSeparationMode  := smNone;
  FAFM             := '082757287';
  FNeedsMapGln     := True;
//  FIsMultiSupplier := True;

  FNeedsMapPayMode := True;

  FPayModeMap.Add('пистысг=епи пистысг');

  FDocTypeMap.Add('41=дап');
  FDocTypeMap.Add('42=дап');
  FDocTypeMap.Add('45=дап');
  FDocTypeMap.Add('4100=дап');
  FDocTypeMap.Add('4101=дап');
  FDocTypeMap.Add('4102=дап');
  FDocTypeMap.Add('4103=дап');
  FDocTypeMap.Add('4104=дап');
  FDocTypeMap.Add('4105=дап');
  FDocTypeMap.Add('4106=дап');
  FDocTypeMap.Add('4107=дап');
  FDocTypeMap.Add('4108=дап');
  FDocTypeMap.Add('4109=дап');
  FDocTypeMap.Add('4110=дап');
  FDocTypeMap.Add('4111=дап');
  FDocTypeMap.Add('4112=дап');
  FDocTypeMap.Add('4113=дап');
  FDocTypeMap.Add('4114=дап');
  FDocTypeMap.Add('4115=дап');
  FDocTypeMap.Add('4120=дап');
  FDocTypeMap.Add('41-R=дап');
  FDocTypeMap.Add('41-т=дап');

  FDocTypeMap.Add('62=тда');
  FDocTypeMap.Add('6020=тда');
  FDocTypeMap.Add('6200=тда');
  FDocTypeMap.Add('6201=тда');
  FDocTypeMap.Add('6202=тда');
  FDocTypeMap.Add('6203=тда');
  FDocTypeMap.Add('6204=тда');
  FDocTypeMap.Add('6205=тда');
  FDocTypeMap.Add('6206=тда');
  FDocTypeMap.Add('6207=тда');
  FDocTypeMap.Add('6208=тда');
  FDocTypeMap.Add('6209=тда');
  FDocTypeMap.Add('6210=тда');
  FDocTypeMap.Add('6211=тда');
  FDocTypeMap.Add('6212=тда');
  FDocTypeMap.Add('6213=тда');
  FDocTypeMap.Add('6214=тда');
  FDocTypeMap.Add('6215=тда');
  FDocTypeMap.Add('62-R=тда');

  FDocTypeMap.Add('61=тил');
  FDocTypeMap.Add('6101=тил');
  FDocTypeMap.Add('6102=тил');
  FDocTypeMap.Add('6103=тил');
  FDocTypeMap.Add('6104=тил');
  FDocTypeMap.Add('6105=тил');
  FDocTypeMap.Add('6106=тил');
  FDocTypeMap.Add('6107=тил');
  FDocTypeMap.Add('6108=тил');
  FDocTypeMap.Add('6109=тил');
  FDocTypeMap.Add('6110=тил');
  FDocTypeMap.Add('6111=тил');
  FDocTypeMap.Add('6112=тил');
  FDocTypeMap.Add('6113=тил');
  FDocTypeMap.Add('6114=тил');
  FDocTypeMap.Add('6115=тил');
  FDocTypeMap.Add('6120=тил');
  FDocTypeMap.Add('61-R=тил');

  FDocTypeMap.Add('63=пеп');
  FDocTypeMap.Add('6300=пеп');
  FDocTypeMap.Add('6301=пеп');
  FDocTypeMap.Add('6302=пеп');
  FDocTypeMap.Add('6303=пеп');
  FDocTypeMap.Add('6304=пеп');
  FDocTypeMap.Add('6305=пеп');
  FDocTypeMap.Add('6306=пеп');
  FDocTypeMap.Add('6307=пеп');
  FDocTypeMap.Add('6308=пеп');
  FDocTypeMap.Add('6309=пеп');
  FDocTypeMap.Add('6310=пеп');
  FDocTypeMap.Add('6311=пеп');
  FDocTypeMap.Add('6312=пеп');
  FDocTypeMap.Add('6313=пеп');
  FDocTypeMap.Add('6314=пеп');
  FDocTypeMap.Add('6315=пеп');
  FDocTypeMap.Add('6320=пеп');
  FDocTypeMap.Add('63-R=пеп');
  FDocTypeMap.Add('66=пеп');

  FDocTypeMap.Add('64=пей');

  FMeasUnitMap.Add('йиб=йиб');
  FMeasUnitMap.Add('йик=йик');
  FMeasUnitMap.Add('тел=тел');

  FGLNMap.Add('35.071=1');    //    лаяаскг 18
  FGLNMap.Add('40.473=2');    //    ваияиамым 1
  FGLNMap.Add('40.476=3');    //    пеяийкеоус 46
  FGLNMap.Add('40.481=5');    //    25 лаятиоу 113-115
  FGLNMap.Add('40.477=6');    //    йяылмгс 38 & поукам
  FGLNMap.Add('40.479=7');    //    йаяайасг 92
  FGLNMap.Add('35.072=8');    //    йгжисиас 12
  FGLNMap.Add('40.480=9');    //    калпяайг 154
  FGLNMap.Add('40.088=10');   //    меа пкациа
  FGLNMap.Add('35.112=13');   //    бемифекоу 14
  FGLNMap.Add('35.091=12');   //    ецматиа 6
  FGLNMap.Add('03.013=13');   //    бемифекоу 14
  FGLNMap.Add('22.112=13');   //    бемифекоу 14
  FGLNMap.Add('35.131=15');   //    мийопокеыс 27 & виоу
  FGLNMap.Add('40.478=17');   //    ихайгс 43
  FGLNMap.Add('40.472=19');   //    паяасйеуопоукоу 5
  FGLNMap.Add('35.073=20');   //    ептакожоу 6
  FGLNMap.Add('35.047=21');   //    л. акенамдяоу 9 пукаиа
  FGLNMap.Add('35.108=21');   //    л. акенамдяоу 9 пукаиа // *** дЕЩТЕЯО
  FGLNMap.Add('40.471=22');   //    аицаиоу
//  FGLNMap.Add('00=99');     //    14вкл хессакомийгс-лоудамиым
  FGLNMap.Add('40.474=23');   //    бихумиас 37
  FGLNMap.Add('40.475=24');   //    помтоу
  FGLNMap.Add('аЖОЯэ пей=24');//    помтоу
  FGLNMap.Add('35.132=25');   //    вакйидийгс
  FGLNMap.Add('35.087=26');   //    теяфгс пукаиа
  FGLNMap.Add('35.109=26');   //    теяфгс пукаиа

end;
(*----------------------------------------------------------------------------*)
procedure TGeorgiadisDescriptor.AddFileItems;
begin
  inherited;

  { master }
//  FItemList.Add(TFileItem.Create(itAFM,  1, 20));
  FItemList.Add(TFileItem.Create(itDate        ,1   ,1-1));
  FItemList.Add(TFileItem.Create(itDocType     ,1   ,2-1));
  FItemList.Add(TFileItem.Create(itDocId       ,1   ,3-1));
  FItemList.Add(TFileItem.Create(itDocChanger  ,1   ,3-1));
  FItemList.Add(TFileItem.Create(itGLN         ,1   ,4-1));    // GLN
  FItemList.Add(TFileItem.Create(itPayType     ,1   ,5-1));

  { detail }
  FItemList.Add(TFileItem.Create(itCode         ,2  , 6-1));
//  FItemList.Add(TFileItem.Create(itBarcode      ,2  , 7-1));
  FItemList.Add(TFileItem.Create(itQty          ,2  , 9-1));
  FItemList.Add(TFileItem.Create(itPrice        ,2  ,10-1));
  FItemList.Add(TFileItem.Create(itVAT          ,2  ,11-1));
  FItemList.Add(TFileItem.Create(itDisc         ,2  ,12-1)); // Value
  FItemList.Add(TFileItem.Create(itLineValue    ,2  ,13-1));
  FItemList.Add(TFileItem.Create(itMeasUnit     ,2  ,14-1));

end;


{ TGeorgiadisReader }
(*----------------------------------------------------------------------------*)
constructor TGeorgiadisReader.Create(Manager: TInputManager; Title: string);
begin
  inherited Create(Manager, Title);
  FDescriptor := FileDescriptors.Find('Input.Descriptor.цеыяциадгс');
end;
(*----------------------------------------------------------------------------*)
function TGeorgiadisReader.GetGLN: string;
begin
  if GetDocType = '64' then
    Result := 'аЖОЯэ пей'
  else
    Result := GetStrDef(fiGLN);
end;
(*----------------------------------------------------------------------------*)
{function TGeorgiadisReader.GetRelDocNum: string;
begin
  Result := GetDocType + GetDocNo;
end;}
(*----------------------------------------------------------------------------*)
function TGeorgiadisReader.GetDiscount: double;
begin
// еэМ ТО ПАЯАСТАТИЙЭ ЕъМАИ дап, Г щЙПТЫСГ ЕъМАИ 100%.
  if (DocType = '41') or
     (DocType = '42') or
     (DocType = '45') or
     (DocType = '4100') or
     (DocType = '4101') or
     (DocType = '4102') or
     (DocType = '4103') or
     (DocType = '4104') or
     (DocType = '4105') or
     (DocType = '4106') or
     (DocType = '4107') or
     (DocType = '4108') or
     (DocType = '4109') or
     (DocType = '4110') or
     (DocType = '4111') or
     (DocType = '4112') or
     (DocType = '4113') or
     (DocType = '4114') or
     (DocType = '4115') or
     (DocType = '4120') or
     (DocType = '41-R') or
     (DocType = '41-т') then
    Result := 100  // дЕМ ЕъМАИ СЫСТЭ, ЦИАТъ Г щЙПТЫСГ ЕъМАИ АНИАЙч.
                   // сЧМЕТАИ ЭЛЫР ЦИАТъ БэФЫ ЙАИ LineValue = 0.00
                   // хА ЛПОЯОЩСА МА УПОКОЦъСЫ GetQty * GetPrice
  else
    Result := inherited GetDiscount;
end;
(*----------------------------------------------------------------------------*)
function TGeorgiadisReader.GetLineValue: Double;
var
  S : string;
begin
  S := GetStrDef(fiLineValue, '0');
//  S := Utls.CommaToDot(S);
//  Result := abs(StrToFloat(S, Utls.GlobalFormatSettings));
  S := DotToComma(S);
  Result := abs(StrToFloat(S));
end;
(*----------------------------------------------------------------------------*)
function TGeorgiadisReader.GetMaterialCode(SupMatCode, SupCode: string; out MatCode: string;
  out MatAA: Integer): Boolean;

  function GetMatCode(SupMatCode, SupCode: string; out MatCode: string; out MatAA: Integer): Boolean;
  begin
    Result := False;

    MatCode := '';
    MatAA   := -1;

  //  if tblMaterial.Locate('SupMatCode', SupMatCode, []) then
    if tblMaterial.Locate('SupMatCode;SupCode', VarArrayOf([SupMatCode, SupCode]), []) then
    begin
      MatCode := tblMaterial.FieldByName('MatCode').AsString;
      MatAA   := tblMaterial.FieldByName('MatAA').AsInteger;

      Result := True;
    end;

  end;

begin
  Result := False;
//  SupMatCode := StripInt(SupMatCode); // ╦ВЕИ ЙЫДИЙОЩР ЛЕ ТЕКЕъА !!!

  if (SupMatCode = '08.02.001') then
    SupMatCode := '70001900';
// епид.циаоуя HIGH PROTEIN жяаоука 237ця лебцак
  if (SupMatCode = '62002030') then
    SupMatCode := '2832';
  if (SupMatCode = '63000013') then
// глисй.туяи лайедомийо 3вкл (ЙЫД ФУЦ=2032)
    SupMatCode := '10.04.026';

  Result := GetMatCode(SupMatCode, SupCode, MatCode, MatAA);

  if not Result then
//      FManager.Log(Self, Format('XXX ERROR: Material Code not found. SupCode: %s, Date1: %s, RelDoc: %s, SupMatCode: %s',
//                     [SupCode, Utls.DateToStrSQL(DocDate, False), RelDoc, SupMatCode]));
  FManager.Log(Self, Format('XXX ERROR: Material Code not found. SupCode: %s, Date1: %s, RelDoc: %s, SupMatCode: %s',
                 [SupCode, DateToStrSQL(DocDate, False), RelDoc, SupMatCode]));
end;
(*----------------------------------------------------------------------------*)
(* цИА ТОМ цеыяциадг ДЕМ ЙэМЫ ТъПОТА ЦИАТъ ЛОУ СТщКМЕИ ТО жпа щТОИЛО ---------*)
function TGeorgiadisReader.GetVAT(MatCode: string): string;

begin
    // еЛЖАМъФЕИ ТО string 'жпа-24'
 // Result := FloatToStr(Abs(StripReal(GetStrDef(fiVAT))));    //yannis commented


  // вЯЕИэФОЛАИ ТО Abs ЦИАТъ ЙЯАТэЕИ ТО "-".


  Result := Copy(GetStrDef(fiVAT), 5, 2);  //yannis code

  end;






(*----------------------------------------------------------------------------*)
function TGeorgiadisReader.DocStrToDate(S: string): TDate;
var ADay, AMonth, AYear : word;
    p : integer;
    ss : string;
begin
  // 1/2/2017
  p := pos('/', s);
  ADay   := StrToInt(LeftString(s, p-1));
  ss := RightString(s, Length(s) - p);
  p := pos('/', ss);
  AMonth := StrToInt(LeftString(ss, p-1));
  AYear  := StrToInt(RightString(s, 4));

  Result := EncodeDate(AYear, AMonth, ADay);
end;
(*----------------------------------------------------------------------------*)






initialization
  FileDescriptors.Add(TGeorgiadisDescriptor.Create);

end.
